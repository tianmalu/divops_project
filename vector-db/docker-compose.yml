version: '3.8'

services:
  weaviate:
    image: semitechnologies/weaviate:1.21.7
    ports:
      - "8081:8080"
    environment:
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - DEFAULT_VECTORIZER_MODULE=text2vec-contextionary
      - ENABLE_MODULES=text2vec-contextionary
      - CONTEXTIONARY_URL=contextionary:9999
    volumes:
      - weaviate-data:/var/lib/weaviate
    depends_on:
      - contextionary
    restart: always
  
  contextionary:
    image: semitechnologies/contextionary:en0.16.0-v1.0.2
    environment:
      OCCURRENCE_WEIGHT_LINEAR_FACTOR: 0.75
      SCHEMA_PROVIDER_URL: etcd:2379
    
  init-schema:
    image: curlimages/curl:latest
    depends_on:
      - weaviate
    entrypoint: >
      sh -c "
      cat /schema.json;
      echo 'Waiting for Weaviate...';
      sleep 10;
      curl -X POST http://weaviate:8080/v1/schema \
      -H 'Content-Type: application/json' \
      --data-binary @/schema.json;
      echo 'Schema uploaded.'
      "
    volumes:
      - ./schema.json:/schema.json
    restart: "no"

volumes:
  weaviate-data: